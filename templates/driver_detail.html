{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3">
  <!-- adapte le titre selon la page -->
  Fiche chauffeur — {{ d.name }}
  <a class="btn btn-sm btn-outline-secondary ms-2" href="{{ url_for('entries_list') }}?driver={{ d.id }}">Voir ses enregistrements</a>
  <a class="btn btn-sm btn-outline-primary ms-2" href="{{ url_for('entries_list', driver=d.id, export=1) }}">Exporter CSV</a>
</h3>

<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted">Total litres</div>
        <div class="h4">{{ '%.2f'|format(total_liters) }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted">Coût total (TND)</div>
        <div class="h4">{{ '%.3f'|format(total_cost) }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted">Moyenne L/100</div>
        <div class="h4">{{ '%.2f'|format(avg_l_100) }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3 d-flex align-items-center">
    <a class="btn btn-outline-secondary" href="{{ url_for('drivers_list') }}">← Chauffeurs</a>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="card-title">Séries mensuelles</h5>

    {% if labels and (labels|length) > 0 %}
      <canvas id="chartLiters" height="100"></canvas>
      <div class="mt-3"></div>
      <canvas id="chartCost" height="100"></canvas>
    {% else %}
      <div class="text-muted">Pas encore de données mensuelles pour ce chauffeur.</div>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="card-title">Séries mensuelles</h5>

    {% if labels %}
      <canvas id="chartLiters" height="100"></canvas>
      <div class="mt-3"></div>
      <canvas id="chartCost" height="100"></canvas>
    {% else %}
      <div class="text-muted">Pas encore de données mensuelles.</div>
    {% endif %}
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ labels|tojson }};
const liters = {{ liters_month|tojson }};
const cost   = {{ cost_month|tojson }};

function money(v){ return new Intl.NumberFormat('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v)+' TND'; }
function litersFmt(v){ return new Intl.NumberFormat('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v)+' L'; }

const commonOpts = {
  responsive:true, maintainAspectRatio:false,
  interaction:{mode:'index', intersect:false},
  plugins:{
    tooltip:{ callbacks:{
      label: ctx => {
        const val = ctx.parsed.y ?? 0;
        return (ctx.dataset.label?.includes('Coût')) ? money(val) : litersFmt(val);
      }
    } }
  },
  scales:{ y:{ beginAtZero:true } }
};

if (labels.length){
  new Chart(document.getElementById('chartLiters').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Litres', data:liters, fill:false }] },
    options: commonOpts
  });
  new Chart(document.getElementById('chartCost').getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ label:'Coût (TND)', data:cost, fill:false }] },
    options: commonOpts
  });
}
</script>
{% endblock %}
