{% extends 'base.html' %}
{% block content %}
<h3 class="mt-3 mb-3">Enregistrements carburant</h3>

<form method="get" action="{{ url_for('entries_list') }}" class="row g-2 mb-3">
  <div class="col-md-3">
    <label class="form-label">V√©hicule</label>
    <select name="vehicle" class="form-select">
      <option value="">Tous les v√©hicules</option>
      {% for v in vehicles %}
        <option value="{{ v.id }}" {% if q_vehicle == v.id %}selected{% endif %}>
          {{ v.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Chauffeur</label>
    <select name="driver" class="form-select">
      <option value="">Tous les chauffeurs</option>
      {% for d in drivers %}
        <option value="{{ d.id }}" {% if q_driver == d.id %}selected{% endif %}>
          {{ d.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Mois</label>
    <input type="text" name="month" class="form-control"
           placeholder="ex : 10 / octobre / 2025-10"
           value="{{ q_month or '' }}">
  </div>

  <div class="col-md-3 d-flex align-items-end">
    <button class="btn btn-outline-secondary me-2" type="submit">Filtrer</button>
    <a class="btn btn-outline-secondary me-2" href="{{ url_for('entries_list') }}">R√©initialiser</a>
    <a class="btn btn-primary"
       href="{{ url_for('entry_new', vehicle=q_vehicle, driver=q_driver, month=q_month) }}">
      + Ajouter
    </a>
  </div>
</form>

<div class="alert alert-light d-flex justify-content-between align-items-center shadow-sm">
  <div>
    <strong>{{ entries|length }}</strong> ligne(s)
    {% if q_vehicle or q_driver or q_month %} ‚Äî vue filtr√©e{% endif %}
  </div>
  <div>
    <span class="me-3">Total litres: <strong>{{ '%.2f'|format(total_liters) }}</strong></span>
    <span class="me-3">Co√ªt total: <strong>{{ '%.3f'|format(total_cost) }} TND</strong></span>
    <span>Moy. L/100: <strong>{{ '%.2f'|format(avg_l_per_100_view) }}</strong></span>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-sm align-middle shadow-sm">
    <thead class="table-light">
      <tr>
        <th>Date</th>
        <th>V√©hicule</th>
        <th>Chauffeur</th>
        <th>Km</th>
        <th>Litres</th>
        <th>Type</th>
        <th>Prix/L</th>
        <th>Total</th>
        <th>L/100</th>
        <th>Station</th>
        <th>Notes</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      {% if entries %}
        {% for entry in entries %}
          <tr>
            <td>{{ entry.date }}</td>
            <td>
              {% if entry.vehicle %}
                <a href="{{ url_for('vehicle_detail', vid=entry.vehicle.id) }}">{{ entry.vehicle.name }}</a>
              {% else %}‚Äî{% endif %}
            </td>
            <td>
              {% if entry.driver %}
                <a href="{{ url_for('driver_detail', did=entry.driver.id) }}">{{ entry.driver.name }}</a>
              {% else %}‚Äî{% endif %}
            </td>
            <td>{{ "%.0f"|format(entry.odometer_km) if entry.odometer_km is not none else '' }}</td>
            <td>{{ "%.2f"|format(entry.liters) if entry.liters is not none else '' }}</td>
            <td>{{ entry.fuel_type.name if entry.fuel_type else '‚Äî' }}</td>
            <td>{{ "%.3f"|format(entry.price_unit) if entry.price_unit is not none else '' }}</td>
            <td>{{ "%.3f"|format(entry.total_cost) if entry.total_cost is not none else '' }}</td>
            <td>
              {% set c = consos.get(entry.id) %}
              {{ '%.2f'|format(c) if c is not none else '‚Äî' }}
            </td>
            <td>{{ entry.station or '' }}</td>
            <td class="text-muted">{{ entry.notes or '' }}</td>
            <td>
              <form method="post"
                    action="{{ url_for('entry_delete', eid=entry.id) }}?vehicle={{ q_vehicle or '' }}&driver={{ q_driver or '' }}&month={{ q_month or '' }}"
                    onsubmit="return confirm('Supprimer cette entr√©e ?');">
                <button class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="12" class="text-muted text-center">Aucune donn√©e trouv√©e.</td></tr>
      {% endif %}
    </tbody>

    <tfoot>
      <tr class="table-light">
        <th colspan="4" class="text-end">Totaux</th>
        <th>{{ '%.2f'|format(total_liters) }}</th>
        <th></th>
        <th></th>
        <th>{{ '%.3f'|format(total_cost) }}</th>
        <th>{{ '%.2f'|format(avg_l_per_100_view) }}</th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </tfoot>
  </table>
</div>

<p class="mt-2">
  <a class="btn btn-sm btn-outline-primary"
     href="{{ url_for('entries_list', vehicle=q_vehicle, driver=q_driver, month=q_month, export=1) }}">
    Exporter la vue (CSV)
  </a>
</p>
{% endblock %}
